{% extends 'back01/base.html' %}

{% block static_files %}
<script type="text/javascript" src="/static/ueditor/ueditor.config.js"></script>
<script type="text/javascript" src="/static/ueditor/ueditor.all.js"></script>
<script src="/static/js/jquery-2.1.0.min.js"></script>
{% endblock %}

{% block body_part %}

<section id="main-content">
    <section class="wrapper">
        <div class="row">
            <div class="col-lg-12">
                <h3 class="page-header"><i class="fa fa-files-o"></i>修改项目</h3>
                <ol class="breadcrumb">
                    <li><i class="fa fa-home"></i><a href="index.html">主页</a></li>
                    <li><i class="icon_document_alt"></i>项目管理</li>
                    <li><i class="fa fa-files-o"></i>修改项目</li>
                </ol>
            </div>
        </div>
        <!-- Form validations -->
        <div class="row" id="article_id" article_id="{{project.project_id}}">
            <div class="col-lg-12">
                <section class="panel">
                    <header class="panel-heading">
                        添加项目
                    </header>
                    <div class="panel-body">
                        <div class="form article">
                            <form id="articleform" class="form-horizontal" onsubmit="return false" action="##" method="post">
                                <div class="form-group ">
                                    <label for="title" class="control-label col-lg-2">标题<span
                                            class="required">*</span></label>
                                    <div class="col-lg-10">
                                        <input class="form-control title" id="title" name="title"
                                               type="text" value="{{project.title}}" required />
                                    </div>
                                </div>






                                 <div class="form-group ">
                                    <label class="control-label col-lg-2">项目成员<span
                                            class="required">*</span></label>
                                    <div class="col-lg-10">
                                      <div class="col-lg-12" >
            <section class="panel">
              <table class="table table-striped table-advance table-hover">
                <tbody >
                  <tr>
                    <th><i class="icon_profile"></i> 姓名</th>
                    <th><i class="icon_calendar"></i> 专业</th>
                    <th><i class="icon_mail_alt"></i> 年级</th>
                    <!--<th><i class="icon_pin_alt"></i> 城市</th>-->
                    <!--<th><i class="icon_mobile"></i> 电话</th>-->
                    <!--<th><i class="icon_cogs"></i> 操作</th>-->
                  </tr>
                     {% for user in teammates %}

                 <tr    class="addkeyword" >
                    <td>   <input id = "name" value="{{ user['name'] }}" class="form-control keyword" name="name" style="margin-bottom: 10px"
                                               type="text" required/></td>
                    <td>   <input id = "faculty" value="{{ user['faculty'] }}"class="form-control keyword" name="faculty" style="margin-bottom: 10px"
                                               type="text" required/></td>
                    <td>   <input id = "grade" value="{{ user['grade'] }}" class="form-control keyword" name="grade" style="margin-bottom: 10px"
                                               type="text" required/></td>
                    <!--<td></td>-->
                    <!--<td></td>-->
                    <!--<td>-->
                      <!--<div class="btn-group">-->
                        <!--<a class="btn btn-primary" href="#"><i class="icon_plus_alt2">修改</i></a>-->
                        <!--&lt;!&ndash;<a class="btn btn-success" href="#"><i class="icon_check_alt2"></i></a>&ndash;&gt;-->
                        <!--<a class="btn btn-danger" href="#"><i class="icon_close_alt2">删除</i></a>-->
                      <!--</div>-->
                    <!--</td>-->
                  </tr>
                   {% endfor %}
          </tbody>
              </table>
            </section>
          </div>
                                        <div class="col-lg-1 ">
                                            <button id="addkeyword" class="btn btn-primary" onclick="MAIN.addkeyword()">添加
                                            </button>
                                        </div>
                                    </div>

                                </div>

                                <div class="form-group ">
                                    <label class="control-label col-lg-2">编辑内容<span
                                            class="required">*</span></label>
                                    <div class="col-lg-10">
                                        <span id="data-content"  data-content="{{ project.brief }}"></span>
                                        <script id="editor" type="text/plain">
                                        </script>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="control-label col-lg-2">上传图片</label>
                                    <div class="col-lg-10">
                                            {% for photo in photos%}
                                            <div class="col-lg-2" style="margin-bottom: 10px">
                                                <a file_id="{{ photo['title'] }}" file_path="{{ photo['path'] }}" class="btn btn-danger" onclick="MAIN.deletefile(this)">{{ photo['title'] }}<i class="icon_close_alt2"></i></a>
                                            </div>
                                        {% endfor %}
                                        <div class="col-lg-12">
                                            <input type="file" id="InputFile" multiple="multiple" name="attachment" >
                                            <!--<p class="help-block">上传附件</p>-->
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-lg-offset-2 col-lg-8">
                                        <button class="btn btn-primary" onclick="MAIN.onSave(0)">保存</button>
                                        <button class="btn btn-default" type="button">取消</button>
                                    </div>
                                    <div class="col-lg-2">
                                        <button class="btn btn-primary" onclick="MAIN.onSave(1)">保存并发布</button>
                                    </div>
                                </div>
                            </form>
                        </div>

                    </div>
                </section>
            </div>
        </div>
    </section>
</section>

<script>

    var MAIN = {};

//    MAIN.ue = UE.getEditor('editor',{
//        serverUrl:"/files/images"
//    })

    $(function (){
        var ue = UE.getEditor('editor');
        var origin_content = $("#data-content").attr("data-content");
        ue.ready(function () {
            ue.setContent(origin_content);
        });
        window.ue = ue;
    });

    MAIN.init = function () {

    }

    MAIN.teammates =  [];


    MAIN.addkeyword = function () {

        var kw = $(".addkeyword:first");
        $("tbody").append(kw.clone())


        $("#name:last").val("")
        $("#faculty:last").val("")
        $("#grade:last").val("")





    }

    MAIN.onSave = function (type) {
        var form = new FormData(document.getElementById("articleform"));
        form.append("is_add",1);
        form.append("type",type);
        form.append("project_id",$("#article_id").attr("article_id"));
       var trs  = $("#name");
        var facultys  = $("#faculty");
        var grades  = $("#grade");

        for(var i=0;i<trs.length;i++){
            // alert (i)

            var name = trs[i].value
            var faculty = facultys[i].value
            var grade = grades[i].value
            var teammate=  [];
            teammate.push(name)
            teammate.push(faculty)
            teammate.push(grade)
            t= teammate.join('||');
          MAIN.teammates.push(t)



        }

        var arr = MAIN.teammates.join('&')

        form.append("teammates",arr)
         var content = MAIN.ue.getContent();
        form.append("brief",content);
        $.ajax({
                url:"/back01/saveProject",
                type:"post",
                data:form,
                processData:false,
                contentType:false,
                success:function(data){
                    alert("success")
                    window.location.reload()
                },
                error:function(e){
                    alert("fail");
                }
            });
    }


    MAIN.deletefile = function (e) {
        var file_id = $(e).attr('file_id');
        var file_path = $(e).attr('file_path');
        var req = {};
        req.project_id=$("#article_id").attr("article_id")
        req.file_id = file_id
        req.file_path = file_path
        Af.rest("/back01/deletePhoto",req,function (data) {
            $(e).parent('div:first').remove();
            alert(data)
        })
    }


//    $(document).ready(function () {
//        MAIN.init();
//    });


    //    $(function () {
    //        $('#datetimepicker').datetimepicker({
    //            format: 'YYYY-MM-DD',
    //            locale: moment.locale('zh-cn')
    //        });
    //    });


</script>


{% endblock %}